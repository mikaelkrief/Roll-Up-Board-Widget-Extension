<!-- ---------------------------------------------------------------------
// <copyright file="index.html">
//    This code is licensed under the MIT License.
//    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF
//    ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED
//    TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
//    PARTICULAR PURPOSE AND NONINFRINGEMENT.
// </copyright>
// <summary>
// widget main page
// </summary>
//---------------------------------------------------------------------
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Roll-Up of the Board</title>
    <link rel="stylesheet" href="css/app.css" type="text/css" />
    <style>
        .bgImage {
            background-image: url('images/unconfigured-small.png');
            height: 40px;
            background-position: center;
            background-repeat: no-repeat;
            background-size: contain;
        }
    </style>
</head>

<body>

    <div class="widget" style="cursor:pointer">

        <div class="title-header" style="font-size:13px"></div>
        <div id="content">
            <table id="tableboard"></table>
        </div>

        <div class="defaultcontent" style="display: block;" id="configwidget">
            <div class="widget-message-text">Configure widget</div>
            <div class="bgImage"></div>
            <span class="link-text"></span>
        </div>
        <div class="loadingcontent" style="display: block;" id="loadingwidget">
            <div style="background-color:lightgray;height:100px;opacity:0.5"></div>
        </div>
    </div>


    <script src="../lib/VSS.SDK.min.js"></script>
    <script src="../lib/ai.0.js"></script>
    <script src="../lib/ldclient.min.js"></script>

    <script type="text/javascript">
        // Initialize the VSS sdk
        VSS.init({
            explicitNotifyLoaded: true,
            setupModuleLoader: true,
            usePlatformScripts: true,
            usePlatformStyles: true
        });

        // Wait for the SDK to be initialized
        VSS.ready(function () {
            VSS.require(["../dist/WidgetRollUpBoard", "TFS/Dashboards/WidgetHelpers", "../dist/LaunchDarklyService", "VSS/Authentication/Services"], function (app, WidgetHelpers, ff, Services) {

                VSS.getAppToken().then((Apptoken) => {
                    WidgetHelpers.IncludeWidgetStyles();
                    let webContext = VSS.getWebContext();
                    console.log(Apptoken);
                    console.log(webContext.user);
                    var user = {
                        "key": webContext.user.id + ":" + webContext.account.name,
                        "email": webContext.user.email,
                        "name": webContext.user.name + "-" + webContext.account.name,
                        "custom": {
                            "account": webContext.account.name
                        }
                    }
                    ff.LaunchDarklyService.init(user, Apptoken.token, webContext.user.id).then((p) => {
                        p.ldClient.on("ready", function () {
                            VSS.register("rollupboardwidget", () => {
                                ff.LaunchDarklyService.setFlags();
                                let rollupboard = new app.WidgetRollUpBoard(WidgetHelpers, ff.LaunchDarklyService);
                                return rollupboard;
                            });
                            VSS.notifyLoadSucceeded();
                        });
                    });
                });
            });
        });
    </script>
</body>

</html>